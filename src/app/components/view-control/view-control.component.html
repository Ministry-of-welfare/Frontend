<div class="container">
  <!-- 
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
    <h2 class="title">📄 קליטת עובדים סוציאליים – קבוצת #1001 </h2> -->

  <div class="header">
    <div class="header-content">
      <div>
        <h1>📄 {{ captureName }} – קבוצת #{{ captureId }} </h1>
        <div class="breadcrumb">
          <a [routerLink]="['/capture']">רשימת קליטות</a>
          <span>←</span>
          <a href=" ">פרוט שורות קליטה</a>

        </div>

      </div>
      <a [routerLink]="['/capture']" fragment="top" class="resett-btn"> ← חזרה לרשימה </a>

    </div>

    <!-- <a href="#capture" class="reset-btn"> חזרה לרשימה</a> 
        <span>→</span>  -->

    <!-- 
    <button class="reset-btn" > ← חזרה
      לרשימה </button> -->
  </div>

  <!-- הכרטסת -->
  <div class="tabs">
    <button [class.active]="selectedTab === 'all'" (click)="selectedTab = 'all'">
      📊 כל השורות ({{ totalRowsCount }})
    </button>
    <button [class.active]="selectedTab === 'errors'" (click)="selectedTab = 'errors'">
      ⚠️ שורות שגויות ({{ errorRowsCount }})
    </button>
    <button [class.active]="selectedTab === 'success'" (click)="selectedTab = 'success'">
      📉 סיכום שגיאות
    </button>
  </div>

  <!-- תוכן -->
  <div *ngIf="selectedTab === 'all'">
    <!-- אפשר לשים את הטבלה שלך -->
    <!-- סינון -->
    <div class="filters">
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #374151;">מספר שורה</label>
        <input [(ngModel)]="filters.rowNumber" placeholder="מספר שורה" class="input" />
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #374151;">עמודה</label>
        <select [(ngModel)]="filters.column" class="input">
          <option value="">כל העמודות</option>
          <option value="tz">ת.ז</option>
          <option value="firstName">שם פרטי</option>
          <option value="lastName">שם משפחה</option>
          <option value="email">כתובת מייל</option>
          <option value="phone">טלפון</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #374151;">סוג שגיאה</label>
        <select [(ngModel)]="filters.errorType" class="input">
          <option value="">כל סוגי השגיאות</option>
          <option value="phone">טלפון לא תקין</option>
          <option value="email">אימייל לא תקין</option>
          <option value="tz">ת.ז לא תקינה</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; color: #374151;">חיפוש טקסט
          חופשי</label>
        <div style="position: relative;">
          <input [(ngModel)]="filters.freeText" placeholder="חיפוש טקסט חופשי" class="input"
            style="padding-left: 2.5rem;" />
          <span
            style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af;"></span>
        </div>
      </div>

      <!-- <label class="checkbox">
      <input type="checkbox" [(ngModel)]="filters.showErrorsOnly" id="showErrors"/>
      הצג רק קליטות עם שגיאות
    </label> -->
      <label class="checkbox">
        <input type="checkbox" [(ngModel)]="filters.showErrorsOnly" (change)="applyFilters()" id="showErrors" />
        הצג רק קליטות עם שגיאות
      </label>




      <!-- <div style="margin-top: 1rem; margin-bottom: 1rem;">
    <input type="checkbox" [(ngModel)]="filters.showErrorsOnly" id="showErrors" >
    <label for="showErrors" class="checkbox"> הצג רק שורות עם שגיאות</label>
  </div> -->
      <div class="actions">
        <button class="search-btn" (click)="search()">🔍 חיפוש </button>
        <button class="reset-btn" (click)="reset()">🔄 איפוס </button>
      </div>
    </div>



    <!-- טבלה -->
    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>פעולות</th>
            <th>סטטוס</th>
            <th>סטטוס עובד</th>
            <th>תאריך התחלה</th>
            <th>תפקיד</th>
            <th>מחלקה מקור</th>
            <th>טלפון</th>
            <th>כתובת מייל</th>
            <th>שם משפחה</th>
            <th>שם פרטי</th>
            <th>ת.ז</th>
            <th>שורה</th>
            <th>בחר</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let row of filteredRows">
            <td style="text-align: center;">
              <button class="action-btn">פעולות</button>
            </td>
            <td style="text-align: center;">
              <span [ngClass]="{
              'status-ok': row.status === 'ok',
              'status-error': row.status === 'error'
            }">
                {{ row.status === 'ok' ? 'תקין' : 'שגיאה' }}
              </span>
            </td>

            <td style="text-align: center;">{{ row.employeeStatus }} </td>
            <td style="text-align: center;">{{ row.startDate }}</td>
            <td style="text-align: center;">{{ row.role }}</td>
            <td style="text-align: center;">{{ row.department }}</td>
         <td style="text-align: center;" 
    [class.error-cell]="hasError(row, 'phone')" 
    (click)="openErrorFromCell(row, 'phone')">
  {{ row.phone }}
</td>
            <td style="text-align: center;" [class.error-cell]="hasError(row, 'email')"
              (click)="openErrorFromCell(row, 'email')">
              {{ row.email }}
            </td>
            <td style="text-align: center;">{{ row.lastName }}</td>
            <td style="text-align: center;">{{ row.firstName }}</td>
            <td style="text-align: center;" [class.error-cell]="hasError(row, 'tz')"
              (click)="openErrorFromCell(row, 'tz')">
              {{ row.tz }}
            </td>
            <td style="text-align: center;">{{ row.id }} </td>
            <td style="text-align: center;">
              <input type="checkbox" [(ngModel)]="row.selected" />
            </td>

          </tr>
        </tbody>
      </table>
    </div>

    <!-- פאג'ינציה -->
    <div style="display: flex; justify-content: center; align-items: center; margin-top: 2rem;">
      <div class="pages">
        <button (click)="previousPage()" [disabled]="currentPage === 1">&laquo;</button>
        <button *ngFor="let page of getPages()" (click)="goToPage(page)" [class.active]="page === currentPage">{{ page
          }}</button>
        <button (click)="nextPage()" [disabled]="currentPage === totalPages">&raquo;</button>
      </div>
    </div>
  </div>

  <div *ngIf="selectedTab === 'errors'" class="errors-container">
    <div class="errors-list">
      <h2>⚠️ רשימת שגיאות בקליטה</h2>

      <div *ngFor="let error of errorDetails" class="error-card" (click)="showErrorOverlay(error)">
        <div class="error-header">
          <strong>{{ error.columnName }}</strong>
          <span class="error-type">{{ error.errorType }}</span>
        </div>
        <div class="error-body">
          <p><b>ערך שהתקבל:</b> {{ error.receivedValue }}</p>
          <p><b>פורמט נדרש:</b> {{ error.requiredFormat }}</p>
          <p><b>הסבר:</b> {{ error.description }}</p>
        </div>
      </div>
    </div>

    <!-- צד ימין/שמאל - פאנל מידע כללי -->
    <div class="side-panel">
      <h3>📋 מידע כללי על הקליטה</h3>
      <p>סה״כ שורות: {{ allRows.length }}</p>
      <p>סה״כ שגיאות: {{ errorDetails.length }}</p>
      <button class="export-btn" (click)="exportErrorsToExcel()">📄 ייצוא השגיאות</button>
    </div>
  </div>

 <div *ngIf="selectedTab === 'success'" class="summary-wrapper">
  <div class="summary-grid">
    <div class="summary-card">
          <!-- 📈 סטטיסטיקה כללית -->

<h3>📈 סטטיסטיקה כללית</h3>
<div class="stats">
  <p><strong>סה״כ שורות:</strong> {{ stats.totalRows }}</p>
  <p><strong>סה״כ שורות תקינות:</strong> {{ stats.totalValidRows }}</p>
  <p><strong>סה״כ שורות שגויות:</strong> {{ stats.totalErrorRows }}</p>
  <p><strong>סה״כ שגיאות:</strong> {{ stats.totalErrors }}</p>
  <p><strong>אחוז שורות תקינות:</strong> {{ stats.successRate }}%</p>
  <p><strong>ממוצע שגיאות לשורה:</strong> {{ stats.avgErrorsPerRow }}</p>
</div>



   
    </div>
<!-- 📊 עמודות בעייתיות -->
<div class="summary-card">
  <h3>📊 עמודות בעייתיות</h3>
  <div class="summary-list">
    <div *ngFor="let err of summaryByError" class="error-summary-item">
      <span>{{ err.columns.join(', ') }}</span>

      <button class="details-btn" (click)="viewErrorColumns(err)">
        פרטים
        <span class="badge">{{ err.count }}</span>
      </button>
    </div>
  </div>
</div>

    <!-- ⚠️ סיכום לפי שגיאה -->
    <div class="summary-card">
      <h3>⚠️ סיכום לפי שגיאה</h3>
      <div class="summary-list">
<div *ngFor="let err of summaryByError" class="error-summary-item">
  <span>{{ err.type }}</span>

  <button class="details-btn" (click)="viewErrorDetails(err)">
    פרטים
    <span class="badge">{{ err.count }}</span>
  </button>
</div>
        
      </div>
    </div>

   

    
  </div>
</div>

<!-- 🔲 מסך כהה עם כל השגיאות לשורה -->
<div class="error-overlay" *ngIf="selectedErrorRow" (click)="closeErrorOverlay()">
  <div class="error-sidebar" (click)="$event.stopPropagation()">

    <div class="error-header">
      <h2>פרטי שגיאות - שורה #{{ selectedErrorRow.id }}</h2>
      <button class="close-btn" (click)="closeErrorOverlay()">✕</button>
    </div>

    <div *ngIf="getErrorsForRow(selectedErrorRow.id)?.length; else noErrors">
      <div class="error-card" *ngFor="let err of getErrorsForRow(selectedErrorRow.id); let i = index">
        <div class="error-card-header">
          <span class="error-num">שגיאה #{{ i + 1 }}</span>
          <span class="error-type">{{ err.errorType }}</span>
        </div>
        <div class="error-card-body">
          <p><b>עמודה:</b> {{ err.columnName }}</p>
          <p><b>ערך שהתקבל:</b> {{ err.receivedValue }}</p>
          <p><b>פורמט נדרש:</b> {{ err.requiredFormat }}</p>
          <p><b>הסבר:</b> {{ err.description }}</p>
        </div>
      </div>
    </div>

    <ng-template #noErrors>
      <p class="no-errors">לא נמצאו שגיאות לשורה זו ✅</p>
    </ng-template>

    <button class="catalog-btn" (click)="viewErrorCatalog()">📘 צפייה בקטלוג שגיאות</button>
  </div>
</div>

  <!-- 🔲 מסך כהה עם פרטי שגיאה
  <div class="error-overlay" *ngIf="selectedError" (click)="closeErrorOverlay()">
    <div class="error-sidebar" (click)="$event.stopPropagation()">
      <h3>🛠 פרטי שגיאה</h3>
      <table class="error-table">
        <tr>
          <th>שורה</th>
          <td>{{ selectedErrorRow?.id }}</td>
        </tr>
        <tr>
          <th>עמודה</th>
          <td>{{ selectedError.columnName }}</td>
        </tr>
        <tr>
          <th>סוג שגיאה</th>
          <td>{{ selectedError.errorType }}</td>
        </tr>
        <tr>
          <th>ערך שהתקבל</th>
          <td>{{ selectedError.receivedValue }}</td>
        </tr>
        <tr>
          <th>פורמט נדרש</th>
          <td>{{ selectedError.requiredFormat }}</td>
        </tr>
        <tr>
          <th>הסבר</th>
          <td>{{ selectedError.description }}</td>
        </tr>
      </table>

      <button class="catalog-btn" (click)="viewErrorCatalog()">📘 צפייה בקטלוג שגיאות</button>
    </div>
  </div> -->


  <div class="actionsexportToExcel">
    <button class="exportToExcel" (click)="exportSelectedToExcel()">📄 ייצוא השרות המסומנות</button>
    <button class="exportToExcel" (click)="reset()" (click)="exportErrorsToExcel()">📄 ייצוא רק שגיאות </button>
  </div>
</div>