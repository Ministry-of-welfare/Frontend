<div class="page-container">
<div class ="header-content">
  <h2 class="page-title">📊 רשימת קליטות קבצים</h2>
<!-- <label >🔘 אדכון אוטומטי</label> -->
</div>
  <!-- כרטיסי סטטוס -->
  <div class="status-cards">
    <div class="card border-blue">
      <div class="value">{{ statusCounts?.waiting ?? '—' }}</div>
      <div class="label">ממתין</div>
    </div>
    <div class="card border-yellow">
      <div class="value">{{ statusCounts?.inprogress ?? '—' }}</div>
      <div class="label">בתהליך</div>
    </div>

    <div class="card border-green">
      <div class="value">{{ statusCounts?.success ?? '—' }}</div>
      <div class="label">הצלחה</div>
    </div>

    <div class="card border-red">
      <div class="value">{{ statusCounts?.error ?? '—' }}</div>
      <div class="label">כישלון</div>
    </div>
  </div>
  <div class="card filters-card">

    <!-- פילטרים -->
    <div class="filters">
      <input type="date" [(ngModel)]="importStartDate" />
      <input type="date" [(ngModel)]="endDate" />
     <select (change)="onSystemChange($event)">
  <option value="">כל המערכות</option>
  <option *ngFor="let s of systems$ | async" [value]="s.SystemId">{{ s.systemName }}</option>
</select>

<select (change)="onSourceChange($event)">
  <option value="">כל המקורות</option>
  <option *ngFor="let src of sources$ | async" [value]="src.ImportDataSourceId">{{ src.importDataSourceDesc }}</option>
</select>

<select (change)="onStatusChange($event)">
  <option value="">כל הסטטוסים</option>
  <option *ngFor="let st of statuses$ | async" [value]="st.ImportStatusId">{{ st.importStatusDesc }}</option>
</select>
      <input type="text" [(ngModel)]="searchTerm" placeholder="שם קובץ..." />

    </div>

    <!-- <label class="checkbox">

      <input type="checkbox" [(ngModel)]="onlyErrors" />
                 הצג רק קליטות עם שגיאות      
    </label> -->
<label class="checkbox">
  <input 
    type="checkbox" 
    [(ngModel)]="onlyErrors" 
    (change)="0" 
  />
  הצג רק קליטות עם שגיאות
</label>

    <div class="actions">
      <button class="btn-reset" (click)="resetFilters()">🔄 איפוס פילטרים</button>
      <button class="btn-search" (click)="applyFilters();onSearchButtonClick()">🔍 חיפוש</button>
    </div>
  </div>

  <!-- <div *ngIf="viewMode === 'table' && !loading" class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>פעולות</th>
            <th>עדכון אחרון</th>
            <th>תאריך יצירה</th>
            <th>סטטוס</th>
            <th>סוג קליטה</th>
            <th>מערכת</th>
            <th>שם עבודה</th>
            <th>תיאור</th>
            <th>מזהה</th>
          </tr>
        </thead> -->

  <div class="card table-card">


      <section class="panel">
    <!-- <div class="card table-card"> -->


    <div class="actions">
    <div class="section-title">🗒️ תוצאות הקליטות </div>

      <button class="btn-reset" (click)="exportToExcel()">
        <!-- <mat-icon>download</mat-icon> -->
        📄 יצוא לאקסל
      </button>
    </div>
    <!-- </div> -->
  </section>

    <!-- טבלה -->
    <table class="data-table">
      <thead>
        <tr>
          <th>מ"ז קליטה</th>
          <th>תיאור מקור</th>
          <th>מערכת</th>
          <th>שם קובץ</th>
          <th>תחילת קליטה</th>
          <th> סיום קליטה </th>
          <th>שורות בקובץ</th>
          <th> שורות שנקלטו</th>
          <th>שורות פגומות </th>
          <th>סטטוס</th>
          <th>פעולות</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredData" (contextmenu)="onContextMenu($event, item)"
          (dblclick)="onRowDoubleClick(item)">
          <td >{{ item.id }}</td>
          <td >{{ item.source }}</td>
          <td >{{ item.system }}</td>
          <td c>{{ item.fileName }}</td>
          <td>{{ item.importStartDate ? (item.importStartDate | date:'dd/MM/yyyy') : '-' }}</td>
<td>{{ item.endDate ? (item.endDate | date:'dd/MM/yyyy') : '-' }}</td>
          <td>{{ item.total }}</td>
          <td>{{ item.loaded }}</td>

          <td>{{ item.failed }}</td>
          
          <td>
 <span class="status-tag" [ngClass]="{
  'success': getStatusToken(item) === 'הצלחה',
  'error':   getStatusToken(item) === 'כישלון',
  'yellow':  getStatusToken(item) === 'בתהליך',
  'gray':    getStatusToken(item) === 'ממתין',

}">
  {{ getStatusToken(item) }}
</span>
          </td>
          <td>קובץ שגיאות</td>  
        </tr>
        <!-- תפריט קונטקסט -->
        <div *ngIf="contextMenuVisible" class="context-menu"
          [ngStyle]="{ top: contextMenuY + 'px', left: contextMenuX + 'px', position: 'fixed', 'z-index': 1000 }"
          (click)="$event.stopPropagation()">
          <div class="context-menu-list">
            <div class="context-menu-item" (click)="viewDetails()">
              <span class="icon">📊</span>
              צפייה בפרטי הקליטה
            </div>
            <div class="context-menu-item" (click)="viewRows()">
              <span class="icon">📋</span>
              צפיה בפרוט שורות הקליטה
            </div>
            <div class="context-menu-item" (click)="viewErrors()">
              <span class="icon">⚠️</span>
              צפיה בשגיאות
            </div>
            <div class="context-menu-item" (click)="downloadErrorReport()">
              <span class="icon">🧹</span>
              הורדת דוח שגיאות
            </div>
            <div class="context-menu-item" (click)="openFilePath()">
              <span class="icon">📁</span>
              פתיחת נתיב הקובץ לאחר עיבוד
            </div>
            <div class="context-menu-item" (click)="showLogs()">
              <span class="icon">📝</span>
              הצגת לוגים
            </div>
          </div>
        </div>
        <!-- סקריפט לסגירת תפריט בלחיצה מחוץ -->
        <div (click)="onDocumentClick($event)" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999"
          *ngIf="contextMenuVisible"></div>
      </tbody>
    </table>
  </div>


<div class="pagination-container">
  <div class="info">
    מציג {{ startItem }} עד {{ endItem }} מתוך {{ totalItems }} תוצאות
  </div>

  <div class="pagination">
    <button (click)="prevPage()" [disabled]="currentPage === 1">הקודם</button>

<ng-container *ngFor="let p of pagesArray">
  <button *ngIf="p !== '...'; else dots"
          class="page-number"
          [class.active]="p === currentPage"
          (click)="changePage(p)">{{ p }}</button>
  <ng-template #dots>
    <button class="page-dots" disabled>...</button>
  </ng-template>
</ng-container>

    <button (click)="nextPage()" [disabled]="currentPage === totalPages">הבא</button>
  </div>

  <!-- <div class="page-size">
    <label>שורות לעמוד:</label>
    <select [value]="pageSize" (change)="changePageSize($event)">
  <option *ngFor="let option of pageSizeOptions" [value]="option">
    {{ option }}
  </option>
</select>

  </div> -->
</div>

  
</div>