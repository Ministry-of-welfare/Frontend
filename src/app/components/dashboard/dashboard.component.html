<!DOCTYPE html>

<html dir="rtl" lang="he">

<head>

  <meta charset="UTF-8">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>דשבורד מערכת קליטת קבצים מכספות</title>

  <!-- styles moved to dashboard.component.css -->

</head>

<body>

  <div class="header">
    <br>
    <h2>🏠 דשבורד מערכת קליטת קבצים מכספות</h2>



  </div>


  <div class="dashboard">

    <!-- Filters (restored as single grouped bar) -->
    <div class="filters-wrapper">
      <div class="filters" role="region" aria-label="סינון">

        <div class="filter-column">
          <label for="status">סטטוס</label>
        <select [(ngModel)]="selectedStatusId" (ngModelChange)="onStatusChange($event)">
  <option [ngValue]="null">כל הסטטוסים</option>
  <option *ngFor="let st of statuses$ | async" [ngValue]="st.importStatusId">{{ st.importStatusDesc }}</option>
</select>
        </div>

        <div class="filter-column">
          <label for="source">מקור קליטה</label>
          <select [(ngModel)]="searchFilters.importSourceId" (change)="onSourceChange($event)">
            <option value="">כל המקורות</option>
            <option *ngFor="let src of sources$ | async" [value]="src.importDataSourceId">{{ src.importDataSourceDesc }}
            </option>
          </select>
        </div>


<div class="filter-column">
  <label for="system">מערכת</label>
  <select (change)="onSystemChange($event)">
    <option value="">כל המערכות</option>
    <option *ngFor="let s of systems$ | async" [value]="s.systemId">{{ s.systemName }}</option>
  </select>
</div>


        <div class="filter-column">
          <label for="dateFrom">מתאריך</label>
          <input id="dateFrom" class="filter-date" type="date" [(ngModel)]="searchFilters.fromDate" (change)="onFromDate($event)" />
        </div>

        <div class="filter-column">
          <label for="dateTo">עד תאריך</label>
          <input id="dateTo" class="filter-date" type="date" [(ngModel)]="searchFilters.toDate" (change)="onToDate($event)" />
        </div>

        <div class="filters-spacer"></div>
        <button class="btn-refresh" (click)="refreshDashboard()" title="עדכן">🔄 רענן</button>

      </div>
    </div>

    <!-- KPIs עליונים -->

    <div class="hero-kpis">

      <div class="kpi-card primary">
        <span class="kpi-icon">📈</span>

        <!-- החלפתי את הערך הקשיח בערך דינמי שמגיע מהקומפוננטה -->
        <div class="kpi-value" id="todayImports">{{ todayImports !== null ? todayImports : '—' }}</div>

        <div class="kpi-label">קליטות היום</div>
        <!-- <div class="kpi-change positive">↗️ +12% מאתמול</div> -->
      </div>

      <div class="kpi-card success">
        <span class="kpi-icon">💯</span>
        <div class="kpi-value">{{ throughputStats.successRateRaw !== undefined ? (throughputStats.successRateRaw + '%')
          : '—' }}</div>
        <div class="kpi-label">אחוז הצלחה</div>
        <!-- <div class="kpi-change positive">↗️ +2.3% השבוע</div> -->
      </div>

      <div class="kpi-card warning">
        <span class="kpi-icon">⚡</span>
        <div class="kpi-value">{{ throughputStats?.avgProcessTime !== undefined ? throughputStats.avgProcessTime : '—'
          }}</div>
        <div class="kpi-label">זמן ממוצע (דקות)</div>
        <!-- <div class="kpi-change negative">↘️ -8% מהממוצע</div> -->
      </div>

      <div class="kpi-card info">
        <span class="kpi-icon">📦</span>
        <div class="kpi-value">{{ dataVolumeLoading ? '...' : (dataVolume.dataVolumeInGB || '—') }}</div>
        <div class="kpi-label">נפח נתונים היום</div>
        <div class="kpi-change positive">↗️ {{ dataVolume.totalRows | number }} רשומות</div>
      </div>

    </div>


    <!-- Layout שלושה טורים -->

    <div class="dashboard-layout">

      <!-- עמודה ראשית - ביצועים לפי מערכת -->

      <div class="main-column">

        <div class="card">

          <div class="card-title">

            🏢 ביצועים לפי מערכת

          </div>

          <div class="chart-container">

            <div class="chart-grid">

              <!-- עמודה שמאל - גרף עוגה -->

              <div class="chart-left">

                <svg width="180" height="180" viewBox="0 0 180 180">

                  <!-- גרף עוגה דינמי -->
                  <ng-container *ngFor="let system of systemStats; let i = index">
                    <circle cx="90" cy="90" r="70" fill="none" [attr.stroke]="system.color" stroke-width="40"
                      [attr.stroke-dasharray]="getCircleDashArray(system.count, i)"
                      [attr.stroke-dashoffset]="getCircleDashOffset(i)" transform="rotate(-90 90 90)" />
                  </ng-container>

                  <!-- טקסט באמצע -->

                  <text x="90" y="85" text-anchor="middle" font-size="24" font-weight="700"
                    fill="#333">{{getTotalFiles()}}</text>

                  <text x="90" y="105" text-anchor="middle" font-size="12" fill="#666">סה"כ קבצים</text>

                </svg>

              </div>


              <!-- עמודה ימין - מקרא וסטטיסטיקות -->

              <div class="chart-legend">

                <div *ngFor="let system of systemStats; let i = index" class="legend-item"
                  [ngClass]="'legend-item--' + (i === 0 ? 'purple' : i === 1 ? 'green' : i === 2 ? 'orange' : 'blue')">
                  <div class="legend-dot"
                    [ngClass]="'legend-dot--' + (i === 0 ? 'purple' : i === 1 ? 'green' : i === 2 ? 'orange' : 'blue')"
                    [style.background-color]="system.color"></div>
                  <div class="legend-text">
                    <div class="legend-title">{{ system.name }}</div>
                    <div class="legend-subtitle">{{ system.count }} קליטות • {{ system.success }}% הצלחה</div>
                  </div>
                </div>




              </div>

            </div>

          </div>

        </div>

      </div>


      <!-- עמודה צדדית 1 - סטטוס קליטות -->

      <div class="side-column-1">

        <div class="status-container">

          <div class="status-title">📋 סטטוס קליטות</div>

          <div class="status-grid">

            <div class="status-card status-blue">

              <div class="status-number">{{ statusCounts?.waiting ?? '—' }}</div>

              <div class="status-label">ממתין לקליטה</div>

            </div>

            <div class="status-card status-orange">

              <div class="status-number">{{ statusCounts?.inProgress ?? '—' }}</div>

              <div class="status-label">בתהליך קליטה</div>

            </div>

            <div class="status-card status-red">

              <div class="status-number">{{ statusCounts?.error ?? '—' }}</div>

              <div class="status-label">נכשל</div>

            </div>

            <div class="status-card status-green">

              <div class="status-number">{{ statusCounts?.success ?? '—' }}</div>

              <div class="status-label">הושלם בהצלחה</div>

            </div>

          </div>

        </div>

      </div>


      <!-- עמודה צדדית 2 - איכות הנתונים (מחליפה את כרטיס ה-SLA) -->

      <!-- כרטיס איכות נתונים -->
      <div class="card">
        <div class="card-title">🎯 איכות נתונים</div>

        <!-- עיגול אחוז הצלחה -->
        <div class="quality-gauge-container">
          <svg width="120" height="120" viewBox="0 0 120 120">
            <circle cx="60" cy="60" r="50" stroke="#f0f0f0" stroke-width="12" fill="none" />
            <circle cx="60" cy="60" r="50" [attr.stroke]="dataQualityStats.successRate >= 90 ? '#4caf50' : '#ff9800'"
              stroke-width="12" fill="none" [attr.stroke-dasharray]="calcCircleDash(dataQualityStats.successRate)"
              stroke-linecap="round" transform="rotate(-90 60 60)" />
            <!-- <text x="60" y="60" text-anchor="middle" dy="7" font-size="20" font-weight="700" fill="#333">
        {{ dataQualityStats.successRate }}%
      </text> -->
            <text x="60" y="55" text-anchor="middle" dy="7" font-size="20" font-weight="700" fill="#333">
              {{ dataQualityStats.successRate }}%
            </text>

            <text x="60" y="75" text-anchor="middle" font-size="14" fill="#555">
              תקינות
            </text>
          </svg>
          <!-- <div class="kpi-label">תקינות</div> -->
        </div>

        <!-- נתונים -->
        <div class="quality-pills">
          <div class="stat-pill stat-pill--large stat-pill--green">
            <div class="stat-number">{{ dataQualityStats.totalValid | number }}</div>
            <div class="stat-label">רשומות תקינות</div>
          </div>

          <div class="stat-pill stat-pill--medium stat-pill--red">
            <div class="stat-number">{{ dataQualityStats.totalInvalid | number }}</div>
            <div class="stat-label">רשומות שגויות</div>
          </div>

          <div class="stat-pill stat-pill--small stat-pill--yellow">
            <div class="stat-number">{{ dataQualityStats.duplicateRecords | number }}</div>
            <div class="stat-label">רשומות כפולות</div>
          </div>
        </div>
      </div>






    </div>


    <!-- שורה תחתונה - שגיאות וקבצים בעייתיים -->

    <div class="bottom-row">

      <!-- שגיאות מובילות -->

      <!-- <div class="card">

        <div class="card-title">

          ⚠️ TOP 10 שגיאות נפוצות

        </div>

        <div class="error-list">

          <div class="error-item">

            <div class="error-info">

              <div class="error-code">שדה חובה חסר</div>

              <div class="error-details">עמודה: תאריך_לידה | קובץ: עובדים סוציאליים</div>

            </div>

            <span class="error-count">34</span>

          </div>

          <div class="error-item">

            <div class="error-info">

              <div class="error-code">פורמט תאריך שגוי</div>

              <div class="error-details">עמודה: תאריך_תחילת_עבודה | קובץ: שעות OkToGo</div>

            </div>

            <span class="error-count">28</span>

          </div>

          <div class="error-item">

            <div class="error-info">

               <div class="error-code">ת.ז. לא קיימת במרשם</div>

              <div class="error-details">עמודה: תעודת_זהות | קובץ: נתוני מפונים</div>

            </div>

            <span class="error-count">21</span>

          </div>

          <div class="error-item">

            <div class="error-info">

              <div class="error-code">כתובת מייל לא תקינה</div>

              <div class="error-details">עמודה: email | קובץ: עובדים סוציאליים</div>

            </div>

            <span class="error-count">18</span>

          </div>

          <div class="error-item">

            <div class="error-info">

              <div class="error-code">ערך לא בטווח המותר</div>

              <div class="error-details">עמודה: שעות_עבודה | קובץ: שעות OkToGo</div>

            </div>

            <span class="error-count">15</span>

          </div>

        </div>

      </div> -->
      <!-- <div class="side-column-2"> -->
      <!-- שגיאות מובילות -->
      <div class="card">
        <div class="card-title"> ⚠️ TOP 10 שגיאות נפוצות</div>
        <div class="error-list">
          <div class="error-item" *ngFor="let error of topErrors" (click)="showErrorDetails(error.id)">
            <div>
              <div class="error-code">{{ error.type }}</div>
              <div class="error-desc">{{ error.details }}</div>
            </div>
            <span class="error-count">{{ error.count }}</span>
          </div>
          <div *ngIf="topErrors.length === 0" class="no-data">אין שגיאות להצגה</div>
        </div>
      </div>


      <!-- קבצים בעייתיים -->

      <div class="card">

        <div class="card-title">

          🚨 קבצים דורשים תשומת לב

        </div>

        <div class="problem-files">

          <div class="problem-item">

            <div class="problem-name">קליטת עובדים סוציאליים - מחוז דרום</div>

            <div class="problem-stats">

              <span class="problem-badge badge-critical">25% כישלון</span>

              <span>זמן עיבוד: 15.2 דק׳</span>

            </div>

          </div>

          <div class="problem-item">

            <div class="problem-name">נתוני מפונים - עדכון שבועי</div>

            <div class="problem-stats">

              <span class="problem-badge badge-warning">18% שגיאות</span>

              <span>סטיית נפח: +45%</span>

            </div>

          </div>

          <div class="problem-item">

            <div class="problem-name">שעות OkToGo - קבצי פברואר</div>

            <div class="problem-stats">

              <span class="problem-badge badge-warning">12% שגיאות</span>

              <span>רשומות כפולות: 23</span>

            </div>

          </div>

          <div class="problem-item">

            <div class="problem-name">מלונות חרום - רשימה יומית</div>

            <div class="problem-stats">

              <span class="problem-badge badge-warning">10% שגיאות</span>

              <span>זמן: 8.5 דק׳</span>

            </div>

          </div>

        </div>

      </div>

    </div>


    <!-- שורה אחרונה - פעילות חיה וקיצורי דרך -->

    <div class="bottom-row">